<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Project Rolcol</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/jpeg" href="https://res.cloudinary.com/gamersio/image/upload/v1758259402/WhatsApp_Image_2025-09-19_at_10.52.49_gpmapd.jpg">
    <link rel="preconnect" href="https://res.cloudinary.com/gamersio/image/upload/v1758259402/WhatsApp_Image_2025-09-19_at_10.52.49_gpmapd.jpg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&family=Smooch+Sans&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {--login-bg: #ECF3F3;--login-primary: #2DAB9A;--login-primary-dark: #248a7b;--login-text: #333;--login-border: #CFD8DC;--dash-bg: #FDF8F0;--dash-primary: #D8974A;--dash-primary-dark: #b87d3a;}
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }
        body {font-family: 'Poppins', 'Montserrat', sans-serif;display: flex;justify-content: center;align-items: center;transition: background-color 0.5s ease;}
        .page-container {width: 100%;height: 100%;display: flex;justify-content: center;align-items: center;padding: 20px;animation: fadeIn 0.5s ease-in-out;}
        .hidden { display: none; }
        @keyframes fadeIn {from { opacity: 0; transform: translateY(15px); }to { opacity: 1; transform: translateY(0); }}
        #login-page { background-color: var(--login-bg);}
        .login-container {background: #FFFFFF;padding: 40px 35px;border-radius: 16px;box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);max-width: 400px; width: 100%; text-align: center;}
        .login-logo { width: 100px; height: 100px; margin: 0 auto 20px;}
        .login-logo img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; box-shadow: 0 4px 15px rgba(0,0,0,0.1);}
        .login-container h2 { color: var(--login-text); font-weight: 600; font-size: 1.8rem; margin-bottom: 5px;}
        .login-container p { color: #777; font-size: 0.9rem; margin-bottom: 30px; letter-spacing: 0.5px;}
        .login-container input {width: 100%; padding: 15px; margin-bottom: 15px; font-size: 1rem; border: 1px solid var(--login-border); border-radius: 12px; background: #f9f9f9; color: var(--login-text); transition: all 0.3s ease;}
        .login-container input:focus {outline: none; border-color: var(--login-primary); box-shadow: 0 0 0 3px rgba(45, 171, 154, 0.2);}
        .login-container #loginBtn {width: 100%; padding: 15px; border: none; border-radius: 12px; background-color: var(--login-primary); color: white; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease;}
        .login-container #loginBtn:hover {background-color: var(--login-primary-dark);}
        #errorMsg { color: #e53935; font-weight: 500; min-height: 24px; margin-bottom: 15px; font-size: 0.9rem;}
        #dashboard-page { background-color: var(--dash-bg); background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='174' viewBox='0 0 100 174'%3E%3Cg fill='%23d8974a' fill-opacity='0.05'%3E%3Cpath d='M25 116h50v43H25zM25 0h50v43H25zM0 87h50v43H0zM50 87h50v43H50zM25 43h50v43H25z'/%3E%3C/g%3E%3C/svg%3E"); }
        .dashboard-container { max-width: 600px; width: 100%; text-align: center;}
        .dashboard-logo {display: block; width: 80px; height: 80px; margin: 0 auto 15px;}
        .dashboard-logo img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.1);}
        .dashboard-container h2 { color: var(--dash-primary); font-weight: 600; font-size: 1.5rem; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 30px;}
        .button-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;}
        .menu-button { background: #fff; border: 2px solid var(--dash-primary); border-radius: 16px; padding: 25px; color: var(--dash-primary); font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(216, 151, 74, 0.1); text-decoration: none;}
        .menu-button:hover { background-color: var(--dash-primary); color: #fff; transform: translateY(-5px); box-shadow: 0 10px 20px rgba(216, 151, 74, 0.2);}
        .menu-button i { font-size: 1.8rem; margin-bottom: 5px;}
        footer { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: #aaa; font-size: 0.8rem;}
        #take-attendance-page, #view-attendance-page, #manual-attendance-page {background-color: #171717; color: #eaeaea; flex-direction: column;}
        #take-attendance-page h1, #view-attendance-page h1, #manual-attendance-page h2 {font-family: "Smooch Sans", sans-serif; font-weight: 500; color: #fff; margin-bottom: 25px; letter-spacing: 1px;}
        video { width: 340px; height: 260px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.7); border: 2px solid #2c2c2c; background: #111;}
        #barcodeResult { font-size: 1.1rem; margin: 25px auto; color: #eaeaea; background: #1f1f1f; padding: 14px 18px; border-radius: 12px; width: 340px; min-height: 2em; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); border: 1px solid #2a2a2a; transition: all 0.3s ease;}
        #barcodeResult.success { color: #00ff9d; border-color: #00ff9d; box-shadow: 0 0 12px rgba(0, 255, 157, 0.3);}
        #barcodeResult.error { color: #ff4d4d; border-color: #ff4d4d; box-shadow: 0 0 12px rgba(255, 77, 77, 0.3);}
        #view-attendance-page { max-width: 900px; margin: auto;}
        #view-attendance-page h2 { font-size: 1.5rem; border-left: 4px solid #00ff9d; padding-left: 10px; text-align: left;}
        label { font-weight: 500; color: #ccc;}
        input[type="date"] { background: #1f1f1f; color: #eaeaea; border: 1px solid #333; border-radius: 8px; padding: 6px 10px; margin-left: 10px;}
        #view-attendance-page button, #manual-attendance-page button { display: inline-block; width: auto; background: #0b84ff; color: white; padding: 8px 14px; margin-left: 10px; cursor: pointer; border-radius: 12px; border: none; }
        #view-attendance-page button:hover, #manual-attendance-page button:hover { background: #0066cc; }
        #summary { margin-top: 20px; font-weight: bold; color: #00ff9d; text-align: center;}
        table { border-collapse: collapse; width: 100%; margin-top: 10px; border-radius: 10px; overflow: hidden; background: #1c1c1c; box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);}
        th, td { padding: 12px 14px; text-align: left;}
        th { background: #222; color: #00ff9d; text-transform: uppercase; font-size: 0.85rem;}
        tr:nth-child(even) { background: #252525; }
        .btn-back { position: absolute; top: 20px; left: 20px; width: auto; background: #333; color: white; font-weight: bold; font-size: 18px; padding: 8px 16px; margin: 0; box-shadow: none; cursor: pointer; border: none; border-radius: 12px;}
        .btn-back:hover { background: #444; }
        #manual-attendance-page { max-width: 420px; margin: 30px auto; padding: 20px; text-align: center;}
        #manual-attendance-page label { display: block; margin-bottom: 8px; font-weight: 600;}
        #manual-attendance-page input, #manual-attendance-page select {width: 100%; padding: 14px; border-radius: 8px; border: 1px solid #333; background: #2a2a2a; color: #eaeaea; font-size: 16px; margin-bottom: 16px; font-family: "Montserrat", sans-serif;}
        #manual-attendance-page button { margin-bottom: 10px;}
        #markManualPresentBtn { background: linear-gradient(135deg, #3b82f6, #2563eb);}
        #markManualPresentBtn:hover { background: linear-gradient(135deg, #2563eb, #3b82f6);}
        #removeManualAttendanceBtn { background: #e44a4a !important;}
        #manualMessage { margin-top: 15px; font-weight: 600; min-height: 24px;}
    </style>
</head>
<body>
    <div id="login-page" class="page-container">
        <div class="login-container">
            <div class="login-logo"><img src="https://res.cloudinary.com/gamersio/image/upload/v1758259402/WhatsApp_Image_2025-09-19_at_10.52.49_gpmapd.jpg" alt="School Logo"></div>
            <h2>Admynistrators School</h2>
            <p>ROLCOL(Roll call application)</p>
            <div id="errorMsg"></div>
            <input type="text" id="userId" placeholder="Teacher ID" autofocus />
            <input type="password" id="password" placeholder="Password" />
            <button id="loginBtn">LOGIN</button>
        </div>
    </div>
    <div id="dashboard-page" class="page-container hidden">
        <div class="dashboard-container">
            <div class="dashboard-logo"><img src="https://res.cloudinary.com/gamersio/image/upload/v1758259402/WhatsApp_Image_2025-09-19_at_10.52.49_gpmapd.jpg" alt="School Logo"></div>
            <h2>Admynistrators School</h2>
            <div class="button-grid">
                <button id="goToTakeAttendance" class="menu-button"><i class="fa-solid fa-check"></i><span>TAKE ATTENDANCE</span></button>
                <button id="goToViewAttendance" class="menu-button"><i class="fa-solid fa-calendar-days"></i><span>VIEW ATTENDANCE LOG</span></button>
                <button id="manualAttendanceBtn" class="menu-button"><i class="fa-solid fa-pencil"></i><span>MANUAL ATTENDANCE</span></button>
                <button id="logoutBtn" class="menu-button"><i class="fa-solid fa-right-from-bracket"></i><span>LOG OUT</span></button>
            </div>
        </div>
        <footer>MADE BY TEAM ADMYNISTRATORS FOR SIH25012</footer>
    </div>
    <div id="take-attendance-page" class="page-container hidden">
        <button class="btn-back">&larr; Back</button>
        <h1>Attendance Scanner</h1>
        <video id="video" autoplay></video>
        <div id="barcodeResult">Scan your barcode to mark present.</div>
    </div>
    <div id="view-attendance-page" class="page-container hidden">
        <button class="btn-back">&larr; Back</button>
        <h1>Attendance Dashboard</h1>
        <div style="text-align:center; margin-bottom:20px;">
            <label for="dateInput">Select Date:</label>
            <input type="date" id="dateInput" />
            <button id="showAttendanceBtn">Show Attendance</button>
        </div>
        <div id="summary"></div>
        <h2>Present Students</h2>
        <table id="presentTable" style="display:none;"><thead><tr><th>ID</th><th>Name</th></tr></thead><tbody></tbody></table>
        <h2>Absent Students</h2>
        <table id="absentTable" style="display:none;"><thead><tr><th>ID</th><th>Name</th></tr></thead><tbody></tbody></table>
    </div>
    <div id="manual-attendance-page" class="page-container hidden">
      <button class="btn-back">&larr; Back</button>
      <h2>Teacher Attendance Overwriter</h2>
      <label for="manualDateInput">Select Date:</label>
      <input type="date" id="manualDateInput" />
      <label for="manualStudentIdInput">Enter Student ID</label>
      <input type="text" id="manualStudentIdInput" placeholder="Student ID" autocomplete="off" />
      <button id="markManualPresentBtn">Mark Present</button>
      <button id="removeManualAttendanceBtn" style="background: #e44a4a;">Remove Attendance</button>
      <div id="manualMessage"></div>
    </div>

    <script type="module">
        // --- Global Variables & DOM Elements ---
        const pages = document.querySelectorAll('.page-container');
        const body = document.querySelector('body');
        let videoStream = null;
        const apiUrl = '/api/attendance'; // This points to our new Vercel API function

        // --- Page Navigation Logic ---
        function showPage(pageId) {
            if (pageId === 'login-page') body.style.backgroundColor = 'var(--login-bg)';
            else if (pageId === 'dashboard-page') body.style.backgroundColor = 'var(--dash-bg)';
            else body.style.backgroundColor = '#171717';

            if (videoStream && !document.getElementById('take-attendance-page').classList.contains('hidden')) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }

            pages.forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');

            if (pageId === 'take-attendance-page') initScanner();
            else if (pageId === 'view-attendance-page') {
                document.getElementById('dateInput').value = new Date().toISOString().slice(0, 10);
                document.getElementById('showAttendanceBtn').click();
            } else if (pageId === 'manual-attendance-page') {
                manualDateInput.value = getTodayDate();
                manualStudentIdInput.value = "";
                manualMessage.textContent = "";
            }
        }

        // --- Login & Dashboard Logic ---
        const errorMsg = document.getElementById('errorMsg');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userIdInput = document.getElementById('userId');
        const passwordInput = document.getElementById('password');
        loginBtn.addEventListener('click', () => {
            if (userIdInput.value.trim() === "teacherA" && passwordInput.value === "12345") {
                errorMsg.textContent = "";
                showPage('dashboard-page');
            } else {
                errorMsg.textContent = "Invalid ID or Password.";
            }
        });
        logoutBtn.addEventListener('click', () => {
            userIdInput.value = "";
            passwordInput.value = "";
            showPage('login-page');
        });
        document.getElementById('goToTakeAttendance').addEventListener('click', () => showPage('take-attendance-page'));
        document.getElementById('goToViewAttendance').addEventListener('click', () => showPage('view-attendance-page'));
        document.getElementById('manualAttendanceBtn').addEventListener('click', () => showPage('manual-attendance-page'));
        showPage('login-page');

        // --- Barcode Scanner Logic ---
        const video = document.getElementById("video");
        const barcodeResult = document.getElementById("barcodeResult");
        let barcodeDetector;

        async function initScanner() {
            barcodeResult.textContent = "Initializing camera...";
            barcodeResult.className = "";
            if (!("BarcodeDetector" in window)) {
                barcodeResult.textContent = "Barcode Detection not supported.";
                barcodeResult.className = "error";
                return;
            }
            if (!barcodeDetector) {
                const supportedFormats = await BarcodeDetector.getSupportedFormats();
                barcodeDetector = new BarcodeDetector({ formats: supportedFormats });
            }
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = videoStream;
                await video.play();
                barcodeResult.textContent = "Scan your barcode to mark present.";
                requestAnimationFrame(scanBarcode);
            } catch (error) {
                barcodeResult.textContent = "Cannot access camera. Grant permissions.";
                barcodeResult.className = "error";
            }
        }

        async function scanBarcode() {
            if (!videoStream || video.paused || document.getElementById('take-attendance-page').classList.contains('hidden')) return;
            try {
                const barcodes = await barcodeDetector.detect(video);
                if (barcodes.length > 0) {
                    const studentId = barcodes[0].rawValue.trim().toUpperCase();
                    const today = new Date().toISOString().slice(0, 10);
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ date: today, studentId: studentId })
                    });
                    const result = await response.json();

                    barcodeResult.textContent = result.message;
                    barcodeResult.className = result.success ? "success" : "error";
                    
                    setTimeout(() => { 
                        if (!document.getElementById('take-attendance-page').classList.contains('hidden')) {
                            requestAnimationFrame(scanBarcode);
                        }
                    }, 2000);
                } else {
                    requestAnimationFrame(scanBarcode);
                }
            } catch (err) {
                requestAnimationFrame(scanBarcode);
            }
        }

        // --- Attendance Viewer Logic ---
        const dateInput = document.getElementById('dateInput');
        async function loadAttendance() {
            const date = dateInput.value;
            if (!date) return alert("Please select a date.");
            const summaryDiv = document.getElementById('summary');
            const [presentTable, absentTable] = [document.getElementById('presentTable'), document.getElementById('absentTable')];
            const [presentBody, absentBody] = [presentTable.querySelector('tbody'), absentTable.querySelector('tbody')];
            presentBody.innerHTML = ''; absentBody.innerHTML = '';
            presentTable.style.display = 'none'; absentTable.style.display = 'none';
            summaryDiv.textContent = 'Fetching attendance data...';
            try {
                const response = await fetch(`${apiUrl}?date=${date}`);
                if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
                
                const { students, attendance } = await response.json();
                if (!students) throw new Error('Could not retrieve student list.');

                const allStudentsIds = Object.keys(students);
                const presentIds = Object.keys(attendance);
                const absentIds = allStudentsIds.filter(id => !presentIds.includes(id));
                
                summaryDiv.innerHTML = `Total: ${allStudentsIds.length} | Present: ${presentIds.length} | Absent: ${absentIds.length}`;
                
                presentIds.forEach(id => {
                    if(students[id]) presentBody.innerHTML += `<tr><td>${id}</td><td>${students[id].name || 'Unknown'}</td></tr>`;
                });
                if(presentIds.length > 0) presentTable.style.display = 'table';
                
                absentIds.forEach(id => {
                    if(students[id]) absentBody.innerHTML += `<tr><td>${id}</td><td>${students[id].name || 'Unknown'}</td></tr>`;
                });
                if(absentIds.length > 0) absentTable.style.display = 'table';

            } catch (error) {
                summaryDiv.textContent = `Error: ${error.message}`;
            }
        }
        document.getElementById('showAttendanceBtn').addEventListener('click', loadAttendance);

        // --- Manual Attendance Override Logic ---
        const manualDateInput = document.getElementById("manualDateInput");
        const manualStudentIdInput = document.getElementById("manualStudentIdInput");
        const markManualPresentBtn = document.getElementById("markManualPresentBtn");
        const removeManualAttendanceBtn = document.getElementById("removeManualAttendanceBtn");
        const manualMessage = document.getElementById("manualMessage");

        function getTodayDate() { return new Date().toISOString().slice(0, 10); }
        manualDateInput.value = getTodayDate();

        function showManualMessage(text, success = true) {
            manualMessage.textContent = text;
            manualMessage.style.color = success ? "#00ff9d" : "#ff4d4d";
        }
        
        async function handleManualAttendance(action) {
            const date = manualDateInput.value;
            const studentId = manualStudentIdInput.value.trim().toUpperCase();
            if (!studentId || !date) return showManualMessage("Please enter a student ID and select a date.", false);
            
            try {
                const method = action === 'mark' ? 'POST' : 'DELETE';
                const response = await fetch(apiUrl, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date, studentId })
                });
                const result = await response.json();
                showManualMessage(result.message, result.success);
            } catch (error) {
                showManualMessage("Error: " + error.message, false);
            }
        }
        markManualPresentBtn.onclick = () => handleManualAttendance('mark');
        removeManualAttendanceBtn.onclick = () => handleManualAttendance('remove');

        // --- General Navigation Event Listeners ---
        document.querySelectorAll('.btn-back').forEach(button => button.addEventListener('click', () => showPage('dashboard-page')));
        document.querySelectorAll('input[type="password"], input[type="text"]').forEach(input => {
             input.addEventListener('keyup', (e) => {
                 if (e.key === 'Enter' && !document.getElementById('login-page').classList.contains('hidden')) loginBtn.click();
             });
         });
    </script>
</body>
</html>